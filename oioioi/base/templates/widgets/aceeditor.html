<style type="text/css">
    #{{ editor_id }} {
        display: none;
        height: 226px;
        width: 100%;
        resize: both;
		overflow: hidden;
        resize: both;
    }
</style>

<div id="{{ editor_id }}">
{{ inner_code }}
</div>

<script>
    var ace_size_offset_h = 12;
    var ace_size_offset_w = 28;
    var editor_started = false;
    var editor_starting = false;
    function start_editor() {
        console.log("starting editor");
        editor_starting = true;
        // Load code dynamicly:
        var ace_script = document.createElement('script');
        var lang_tools_script = document.createElement('script');

        ace_script.src = "https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.14/ace.js";
        ace_script.integrity = "sha512-6ts6Fu561/yzWvD6uwQp3XVYwiWNpWnZ0hdeQrETqtnQiGjTfOS06W76aUDnq51hl1SxXtJaqy7IsZ3oP/uZEg==";
        ace_script.crossOrigin = "anonymous";
        ace_script.referrerPolicy = "no-referrer";

        lang_tools_script.src = "https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.14/ext-language_tools.min.js";
        lang_tools_script.integrity = "sha512-S7Whi8oQAQu/MK6AhBWufIJIyOvqORj+/1YDM9MaHeRalsZjzyYS7Usk4fsh+6J77PUhuk5v/BxaMDXRdWd1KA==";
        lang_tools_script.crossOrigin = "anonymous";
        lang_tools_script.referrerPolicy = "no-referrer";

        ace_script.onload = function () {
            console.log("loadded 1");
            document.documentElement.firstChild.appendChild(lang_tools_script);
            lang_tools_script.onload = function() {

                console.log("start");
                ace.require("ace/ext/language_tools");
                var editor = ace.edit("{{ editor_id }}");
                editor.session.setMode("ace/mode/c_cpp");
                editor.setTheme("ace/theme/chrome");
                editor.setOptions({
                    enableBasicAutocompletion: true,
                    enableSnippets: true,
                    enableLiveAutocompletion: true,
                    fontSize: 15,
                });
                var textarea = $('textarea[name="code"]').hide();
                editor.getSession().on('change', function(){
                    textarea.val(editor.getSession().getValue());
                });
                document.addEventListener("mouseup", function(e){
                    editor.resize();
                });
                editor_started = true;
                editor_starting = false;
                console.log("Editor started");
                toggle_editor(true);
            }
        };
        console.log("ace append");
        document.documentElement.firstChild.appendChild(ace_script);
    }
    function toggle_editor(state) {
        if (editor_starting) {
            return;
        }
        if (!editor_started && !state) {
            return;
        }
        if (!editor_started) {
            start_editor();
            return;
        }
        if (state) {
            console.log("On");
            var editor = ace.edit("{{ editor_id }}");
            var textarea = $('textarea[name="code"]');
            editor.getSession().setValue(textarea.val());

            $("#{{ editor_id }}").show();
            textarea.hide();
        }
        else {
            console.log("Off");
            $('textarea[name="code"]').show();
            $("#{{ editor_id }}").hide();
        }
    };
    $( document ).ready(function() {
        const checkbox = document.getElementById('{{ toggle_checkbox_id }}');
        toggle_editor( {{ default_state }} );
        checkbox.addEventListener('change', (event) => {
            toggle_editor(event.currentTarget.checked);
        })
    });
</script>